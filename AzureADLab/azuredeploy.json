{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "artifactsLocation": {
            "type": "string"
        },        
        "studentSubnetName": {
            "type": "string"
        },
        "studentSubnetAddressPrefix": {
            "type": "string"
        },
        "virtualNetworkName": {
            "type": "string"
        },
        "virtualNetworkAddressRange": {
            "type": "string"
        },
        "studentAdminUsername": {
            "type": "string"
        },
        "studentAdminPassword": {
            "type": "securestring"
        },
        "storageAccountName": {
            "type": "string"
        },
        "adAdminUsername": {
            "type": "string"
        },
        "adAdminPassword": {
            "type": "securestring"
        },
        "domainName": {
            "type": "string"
        },
        "adVMName": {
            "type": "string"
        },
        "adNicIpAddress": {
            "type": "string"
        },
        "adVmSize": {
            "type": "string"
        },
        "adImagePublisher": {
            "type": "string"
        },
        "adImageOffer": {
            "type": "string"
        },
        "adImageSku": {
            "type": "string"
        },
        "clientVMName": {
            "type": "string"
        },
        "clientNicIpAddress": {
            "type": "string"
        },
        "clientVmSize": {
            "type": "string",
        },
        "clientImagePublisher": {
            "type": "string"
        },
        "clientImageOffer": {
            "type": "string"
        },
        "clientImageSku": {
            "type": "string"
        },
        "serverVMName": {
            "type": "string"
        },
        "serverNicIpAddress": {
            "type": "string"
        },
        "serverVmSize": {
            "type": "string",
        },
        "serverImagePublisher": {
            "type": "string"
        },
        "serverImageOffer": {
            "type": "string"
        },
        "serverImageSku": {
            "type": "string"
        },
        "linuxVMName": {
            "type": "string"
        },
        "linuxNicIpAddress": {
            "type": "string"
        },
        "linuxVmSize": {
            "type": "string",
        },
        "linuxImagePublisher": {
            "type": "string"
        },
        "linuxImageOffer": {
            "type": "string"
        },
        "linuxImageSku": {
            "type": "string"
        }
    },
    "variables": {
        "apiVersion": "2015-06-15",
        "vnetID": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnetId": "[concat(variables('vnetID'),'/subnets/', parameters('studentSubnetName'))]",

    },
    "resources": [{
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[parameters('storageAccountName')]",
            "apiVersion": "2016-01-01",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "Storage",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "VNet",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/vnet.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnetName": {
                        "value": "[parameters('studentSubnetName')]"
                    },
                    "subnetRange": {
                        "value": "[parameters('studentSubnetAddressPrefix')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "createDomain",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/createDomain.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adAdminUsername": {
                        "value": "[parameters('adAdminUsername')]"
                    },
                    "adAdminPassword": {
                        "value": "[parameters('adAdminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adVMName": {
                        "value": "[parameters('adVMName')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "adServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/client.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('adVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('adVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('adImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('adImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('adImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "LinuxServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/client.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('linuxVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('linuxNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('linuxVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('linuxImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('linuxImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('linuxImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "HomeServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/client.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('clientVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('clientNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('clientVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('clientImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('clientImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('clientImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "domainJoin-Client",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('artifactsLocation'), '/nestedtemplates/domainJoin.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('clientVMName')]"
                    },
                    "adAdminUsername": {
                        "value": "[parameters('adAdminUsername')]"
                    },
                    "adAdminPassword": {
                        "value": "[parameters('adAdminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adVMName": {
                        "value": "[parameters('adVMName')]"
                    }                    
                }
            }
        }
    ]
}