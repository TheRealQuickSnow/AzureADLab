{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "The name of the administrator account of the new VM and domain"
            }
        },
        "adAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the administrator account of the new VM and domain"
            }
        },
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "The FQDN of the Active Directory Domain to be created"
            }
        },
        "artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources, such as templates and DSC modules, that the template depends on"
            },
            "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/active-directory-new-domain"
        },
        "virtualNetworkName": {
            "type": "string"
        },
        "storageAccountName": {
            "type": "string"
        },
        "adNicName": {
            "type": "string"
        },
        "adNicIpAddress": {
            "type": "string"
        },
        "adVMName": {
            "type": "string"
        },
        "adVmSize": {
            "type": "string"
        },
        "studentSubnetName": {
            "type": "string"
        },
        "publicIPAddressName": {
            "type": "string"
        },
        "adAvailabilitySetName": {
            "type": "string"
        },
        "virtualNetworkAddressRange": {
            "type": "string"
        },
        "studentSubnetAddressPrefix": {
            "type": "string"
        },
        "clientVmSize": {
            "type": "string",
            "defaultValue": "Standard_A2",
            "metadata": {
                "description": "The size of the virtual machines"
            }
        },
        "clientAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "The name of the administrator of the new VM and the domain. Exclusion list: 'admin','administrator"
            }
        },
        "clientAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the administrator account of the new VM and the domain"
            }
        },
        "clientNicIpAddress": {
            "type": "string"
        }
    },
    "variables": {
        "apiVersion": "2015-06-15",
        "vnetID": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnetId": "[concat(variables('vnetID'),'/subnets/', parameters('studentSubnetName'))]",

    },
    "resources": [{
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[parameters('storageAccountName')]",
            "apiVersion": "2016-01-01",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "Storage",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "VNet",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/vnet.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnetName": {
                        "value": "[parameters('studentSubnetName')]"
                    },
                    "subnetRange": {
                        "value": "[parameters('studentSubnetAddressPrefix')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "createDomain",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/createDomain.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adAdminUsername": {
                        "value": "[parameters('adAdminUsername')]"
                    },
                    "adAdminPassword": {
                        "value": "[parameters('adAdminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adVMName": {
                        "value": "[parameters('adVMName')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "adServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/domainController.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('adVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('adVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('adImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('adImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('adImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "LinuxServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/client.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('linuxVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('linuxNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('linuxVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('linuxImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('linuxImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('linuxImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "HomeServer",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/client.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('clientVMName')]"
                    },
                    "nicIpAddress": {
                        "value": "[parameters('clientNicIpAddress')]"
                    },
                    "vMSize": {
                        "value": "[parameters('clientVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('studentAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('studentAdminPassword')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },                    
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "adNicIPAddress": {
                        "value": "[parameters('adNicIpAddress')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('clientImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('clientImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('clientImageSku')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "domainJoin-Client",
            "apiVersion": "2016-02-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/nestedtemplates/domainJoin.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('clientVMName')]"
                    },
                    "adAdminUsername": {
                        "value": "[parameters('adAdminUsername')]"
                    },
                    "adAdminPassword": {
                        "value": "[parameters('adAdminPassword')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adVMName": {
                        "value": "[parameters('adVMName')]"
                    }                    
                }
            }
        }
    ]
}